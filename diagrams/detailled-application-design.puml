@startuml
!include C4/C4_Container.puml
title detailed-application-architecture
header Container diagram \ nDetailed application point of view \ n My Online Info Project (AllMyData)
LAYOUT_WITH_LEGEND()
Person_Ext(company, "Company", "[person] \ nWeb client (PC, tablet, mobile)")

System_Boundary(administration, "System administration B") {
    Container(scompta, "Accounting system", "REST service")
}

System_Boundary(si, "Information System") {
    Container(static_resources, "gui-allmydata Web Application", "Container: nginx", "Deliver the static resources (js, html, images ...) of the AllMyData GUI")
    Container(spa, "SPA gui-allmydata", "Container: javascript, React.js", "Graphical interface for requesting information")
    Container(mobile, "AllMyData mobile application", "Container: Android", "Graphical interface to request information")
    Container(sm, "service-allmydata", "Container: Tomcat, Spring Boot", "REST service allowing to request information")
    Container(batch, "batch-process-requests", "Container: groovy", "Process requests, launched by cron every minute")
    ContainerDb(file, "file-requests", "Container: RabbitMQ", "Stores requests")
    ContainerDb(bdd, "bdd-allmydata", "Container: PostgreSQL", "Internal database")
    Container(compo, "service-compo-pdf", "Container: Wildfly, JasperReport", "Composition REST service")
    Container(smails, "mail server", "Container: Postfix", "Send emails")
}

Rel(company, static_resources, "Visit https://allmydata.gouv", "HTTPS, synchronous, read only")
Rel(company, spa, "Retrieves information via")
Rel(company, mobile, "Retrieves information via")
Rel(static_resources, spa, "Provide to client's web browser", "HTTPS, synchronous, read-only")
Rel(spa, sm, "[1.1] Info request", "HTTPS, synchronous, read only")
Rel(mobile, sm, "[1.1] Information request", "HTTPS, synchronous, read only")
Rel(sm, bdd, "[1.2] Historization of the request", "JDBC, synchronous, write")
Rel(sm, file, "[1.3] Request storage", "JMS, synchronous, write")
Rel(batch, file, "[2.1] Pop requests", "JMS, asynchronous, read then delete")
Rel(batch, scompta, "[2.2] Retrieving accounting information", "HTTPS, synchronous, read only")
Rel(batch, compo, "[2.3] PDF creation", "HTTP, synchronous, read")
Rel(batch, smails, "[2.4] Request to send mail with PDF", "SMTP, synchronous, execution")
Rel(smails, company, "[2.5] Sending mail with PDF", "SMTP, synchronous, execution")

@enduml